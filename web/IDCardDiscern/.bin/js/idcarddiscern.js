$(function(){var n=-1;var s=false;var a=false;var e=0;var t=function(n){console.log("[nfc] state = "+n);if(n){$("#nfcTip").html("打开！");$("#discernOpen").removeAttr("disabled");$("#watchMessage").html("操作提示：NFC功能已开启！");$("#watchMessage").css("color","rgba(0, 0, 0, .5)")}else{$("#nfcTip").html("关闭！");$("#discernOpen").attr("disabled","disabled");$("#watchMessage").html("操作提示：NFC功能已关闭！");$("#watchMessage").css("color","rgba(0, 0, 0, .5)")}};var p=function(n){console.log(n);var s={name:"某某某",sex:"男",nation:"汉",birthday:"2000年1月1日",add:"XX省XX市XX区",ID:"338888888888888888",organ:"XXXX公安局",validPeriod:"2015.01.01~2025.01.01"};var a=[];for(var t=0;t<e;t++){a[t]={};Object.assign(a[t],s);a[t].name=s.name+" ( "+(e-t)+" )";if(t===2){t=e}}var p=[];for(var o=0;o<a.length;o++){p[o]={data:{recordType:"json",mediaType:"",data:a[o]},url:"myPath/myFileName.txt"}}console.log("[nfc] 打印虚拟身份证信息：");console.log(p);if($("#IDCardInfo")){$("#IDCardInfo").remove()}var c=$("#showGetedInfo");var b=$("<div class='well a-bounceinT' id='IDCardInfo'></div>");var r=null;for(var d=0;d<p.length;d++){r=$("<div class='detailInfo' id='detailInfo_"+d+"'></div>");$("<span>姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.name+"</span><br/>").appendTo(r);$("<span>性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.sex+"</span><br/>").appendTo(r);$("<span>民&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;族:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.nation+"</span><br/>").appendTo(r);$("<span>出&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;生:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.birthday+"</span><br/>").appendTo(r);$("<span>住&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;址:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.add+"</span><br/>").appendTo(r);$("<span>身份证号:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.ID+"</span><br/>").appendTo(r);$("<span>签发机关:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.organ+"</span><br/>").appendTo(r);$("<span>有效期限:&nbsp;&nbsp;&nbsp;&nbsp;"+p[d].data.data.validPeriod+"</span><br/>").appendTo(r);$(r).appendTo(b);$(b).appendTo(c)}if(p.length>1){$("#showGetedInfo").css("height","380px")}else{$("#showGetedInfo").css("height","253px")}$("#watchMessage").html("操作提示："+p[0].data.data.name+" 识别成功！")};var o=function(){navigator.nfc.watch(function(n){$("#watchMessage").css("color","#00d659");console.log("[nfc] *************************************");console.log("[nfc] *             数据上报              *");console.log("[nfc] *************************************");e+=1;console.log("[nfc] 识别数量统计 ："+e);p(n)}).then(function(s){console.log("[nfc] watchId = "+s);n=s;a=true;$("#openTips").html("已开启！");$("#watchMessage").html("操作提示：请将身份证置于NFC部位！");$("#watchMessage").css("color","rgba(0, 0, 0, .5)");$("#discernOpen")[0].checked=true;$("#discernOpen").removeAttr("disabled")}).catch(function(n){console.log("[nfc] err = "+n)})};var c=function(){console.log("[nfc] get NFC state");atelier.systemsettings.getProperty(atelier.SystemSettingsConstants.NFC_STATE).then(function(n){console.log("[nfc] type= "+n.type+",state= "+n.state);s=n.state;t(n.state);if(s){o()}else{$("#openTips").html("已关闭！");$("#watchMessage").html("操作提示：请先开启NFC功能！");$("#watchMessage").css("color","rgba(0, 0, 0, .5)");$("#discernOpen")[0].checked=false;$("#discernOpen").attr("disabled","disabled")}}).catch(function(n){console.warn("[nfc] errorCode: "+n.errorCode)})};var b=function(){navigator.nfc.cancelWatch(n).then(function(){console.log("[nfc] successed cancelWatch.");a=false;e=0;$("#openTips").html("已关闭！");$("#watchMessage").html("");if($("#IDCardInfo")){$("#IDCardInfo").remove();$("#showGetedInfo").css("height","0px")}}).catch(function(n){console.warn("[nfc] fail cancelWatch. err = "+n);$("#watchMessage").html("操作提示：关闭失败！");$("#watchMessage").css("color","#ff3320")})};c();atelier.systemsettings.addEventListener(atelier.SystemSettingsConstants.NFC_STATE,function(n){console.log("[nfc] type= "+n.type+",state= "+n.state);s=n.state;t(n.state);if(!s&&a){b();$("#discernOpen")[0].checked=false}});$("#discernOpen").click(function(){if(a){b()}else{o()}})});